# Background scripts and extension service worker

Different browsers have different support for [background script and extension service worker](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background#browser_support).

Chrome calls it extension service worker in manifest V3 whereas Mozilla calls it background scripts, but both are declared by.the `background` key in `manifest.json`. For simplicity, we will just call them "background worker" in this page.

Background worker can be used to support the complexity in browser extensions. The pattern of content scripts, popup, or any other page communicating with the background worker to get data or instructions resembles a client-server communication.

A default background worker is created in your project, if you have used the project template to create a new project, or used bootstrap for existing project.

Otherwise, you can create a new `BackgroundWorker.cs` class with the content below.

```csharp
public partial class BackgroundWorker : BackgroundWorkerBase
{
    [BackgroundWorkerMain]
    public override void Main()
    {
        WebExtensions.Runtime.OnInstalled.AddListener(OnInstalled);
    }

    async Task OnInstalled()
    {
        var indexPageUrl = WebExtensions.Runtime.GetURL("index.html");
        await WebExtensions.Tabs.Create(new()
        {
            Url = indexPageUrl
        });
    }
}
```

In the manifest, the background worker is declared in the `background` key.

```json
{
  ...
  "background": {
    "service_worker": "content/BackgroundWorker.js",
    "type": "module"
  },
  ...
}
```


## Mozilla Firefox

The implementation in Firefox requires a small adjustment in the `manifest.json`.

```json
{
  ...
  "background": {
    "scripts": ["content/BackgroundWorker.js"],
    "type": "module"
  },
  ...
}
```


## Where does this `content/BackgroundWorker.js` come from?

In Background Worker, all the registrations of the event listeners have to be done synchronously, and no dynamic `import` is allowed.

The `content/BackgroundWorker.js` file is generated by this package, if you have a class inheriting from the `BackgroundWorkerBase` class, and the `Main()` method is decorated with the `[BackgroundWorkerMain]` attribute, in the following steps:

1. The `Blazor.BrowserExtension.Analyzer` package is responsible for reading the code in the `Main()` method and translate it into JavaScript, storing it temporarily in the file `obj/BackgroundWorkerMain.generated.js`.
0. The `Blazor.BrowserExtension` build resolves all the imported modules and generates the file `content/BackgroundWorker.js`.

The generated file looks like

```javascript
// All the dependencies are statically imported because dynamic import is not allowed
import ...;
import ...;

// Functions for handling import calls from other .js files
const allImports = ...
const importModule = ...
globalThis.importProxy = ...

// Generated by Blazor.BrowserExtension.Analyzer
// Translated JavaScript from the C# Main() method
// "Console.WriteLine("Initializing");" translates to "console.log("Initializing");"
```

> Note: By default all the content files other than the files imported by this package are excluded by default.
> If you want to statically import other content files from a 3rd party library, you can add the following to the `.csproj` file.
> ```xml
> <ItemGroup>
>   <BrowserExtensionBackgroundWorkerImportIncludeContent Include="content/PackageId1/path/to/script1.js" />
>   <BrowserExtensionBackgroundWorkerImportIncludeContent Include="content/PackageId2/path/to/script.js" />
> </ItemGroup>
> ```


# Reference

- [Chrome for Developers](https://developer.chrome.com/docs/extensions/develop/concepts/service-workers)
- [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Background_scripts)
